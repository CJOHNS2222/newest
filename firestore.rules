rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // A user can create their own user document and read/write to all of their own data (documents and subcollections)
    match /users/{userId}/{documents=**} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Households top-level doc - create allowed if creator included in memberIds
    match /households/{householdId} {
      allow create: if request.auth != null
        && request.resource.data.memberIds is list
        && request.resource.data.members is list
        && request.auth.uid in request.resource.data.memberIds;

      // Reading/updating/deleting household top-level doc requires membership
      // Use `resource.data` so queries and list operations can be authorized per-document.
      allow read, update, delete: if request.auth != null
        && request.auth.uid in resource.data.memberIds;
    }

    // Household subcollections: require membership on the household
    match /households/{householdId}/{subCollection=**} {
      // Household subcollections require membership on the household. Check the parent
      // household document's `memberIds` to authorize both reads and writes.
      allow read, write: if request.auth != null
        && request.auth.uid in get(/databases/$(database)/documents/households/$(householdId)).data.memberIds;
    }

    // Public ratings collection (Community)
    match /ratings/{docId} {
      allow read: if true;
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null && request.auth.uid == resource.data.userId;
    }

    // Feedback collection: allow authenticated users to create feedback
    match /feedback/{docId} {
      allow create: if request.auth != null;
      allow read: if false; // Only allow creation, no reading for privacy
    }

    // Default deny
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
