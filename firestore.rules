rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Users may read/write only their own user-scoped data
    match /users/{userId}/{document=**} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Households top-level doc - create allowed if creator included in memberIds
    match /households/{householdId} {
      allow create: if request.auth != null
        && request.resource.data.memberIds is list
        && request.resource.data.members is list
        && request.auth.uid in request.resource.data.memberIds;

      // Reading/updating/deleting household top-level doc requires membership
      // Use `resource.data` so queries and list operations can be authorized per-document.
      allow read, update, delete: if request.auth != null
        && request.auth.uid in resource.data.memberIds;
    }

    // Household subcollections: require membership on the household
    match /households/{householdId}/{subCollection=**} {
      // Household subcollections require membership on the household. Check the parent
      // household document's `memberIds` to authorize both reads and writes.
      allow read, write: if request.auth != null
        && request.auth.uid in get(/databases/$(database)/documents/households/$(householdId)).data.memberIds;
    }

    // Public ratings collection (Community)
    match /ratings/{docId} {
      allow read: if true;
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null && request.auth.uid == resource.data.userId;
    }

    // Notifications: allow only the recipient (by email) to read/update/delete
    // and require authenticated creators to create notifications for themselves.
    // Cloud Functions using the admin SDK bypass these rules so server-side writes remain possible.
    match /notifications/{docId} {
      // Create only if the authenticated user is creating a notification for their own email
      allow create: if request.auth != null && request.resource.data.email == request.auth.token.email;
      // Reads are allowed only to the document recipient
      allow read: if request.auth != null && resource.data.email == request.auth.token.email;
      // Allow the recipient to update/delete their own notification (e.g., mark as read)
      allow update, delete: if request.auth != null && resource.data.email == request.auth.token.email;
    }

    // Default deny
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
